<!-- AUTH GATE -->
<div *ngIf="!auth.currentAccountId(); else diaryUi" class="panel" style="max-width:720px; margin:24px auto;">
  <h2 style="padding:16px;">{{ 'LOGIN' | translate }}</h2>
  <div class="panel-body" style="display:grid; gap:16px;">

    <!-- Register Account -->
    <div class="card" style="border:1px solid var(--border); border-radius:12px; padding:12px;">
      <h3>{{ 'REGISTER_ACCOUNT' | translate }}</h3>
      <label>{{ 'ACCOUNT_NAME' | translate }}</label>
      <input type="text" [(ngModel)]="newAccName" class="btn" style="width:100%;"
        [attr.placeholder]="'ACCOUNT_NAME' | translate">
      <label>{{ 'PASSWORD' | translate }}</label>
      <input type="password" [(ngModel)]="newAccPassword" class="btn" style="width:100%;"
        [attr.placeholder]="'PASSWORD' | translate">
      <div style="margin-top:8px;">
        <button class="btn primary" (click)="registerAccount()">{{ 'CREATE_ACCOUNT' | translate }}</button>
      </div>
    </div>

    <!-- Login -->
    <div class="card" style="border:1px solid var(--border); border-radius:12px; padding:12px;">
      <h3>{{ 'LOGIN' | translate }}</h3>
      <label>{{ 'ACCOUNT' | translate }}</label>
      <select class="btn" [(ngModel)]="selectedLoginAccountId" style="width:100%;">
        <option [ngValue]="null" disabled>{{ 'ACCOUNT' | translate }}</option>
        <option *ngFor="let a of auth.accounts()" [ngValue]="a.id">{{ a.name }}</option>
      </select>

      <div *ngIf="loginMode === 'account'">
        <label>{{ 'PASSWORD' | translate }}</label>
        <input type="password" [(ngModel)]="loginPassword" class="btn" style="width:100%;"
          [attr.placeholder]="'PASSWORD' | translate">
      </div>

      <div style="margin-top:8px;">
        <button class="btn primary" (click)="login()">{{ 'LOGIN' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<ng-template #diaryUi>
  <div class="wrap">
    <div class="header">
      <!-- <div class="title">{{ 'APP_TITLE' | translate }}</div> -->
      <!-- Title: view mode -->
      <div class="title" *ngIf="!isEditingTitle()" style="display:flex; align-items:center; gap:8px;">
        <!-- Logo -->
        <img src="assets/logo.png" alt="Logo" style="height:32px; width:auto; border-radius:6px;" />

        <!-- App title -->
        {{ customTitle() || ('APP_TITLE' | translate) }}
        <button class="icon-btn" (click)="startEditTitle()" title="{{ 'EDIT' | translate }}">‚úèÔ∏è</button>
      </div>

      <!-- Title: edit mode -->
      <div class="title" *ngIf="isEditingTitle()" style="display:flex; align-items:center; gap:8px;">
        <input class="btn" type="text" [ngModel]="titleInput" (ngModelChange)="titleInput = $event"
          style="font-size:22px; font-weight:700; width: min(420px, 60vw);" />
        <button class="title-edit-btn btn primary" (click)="saveTitle()">{{ 'SAVE' | translate }}</button>
        <button class="title-edit-btn btn" (click)="cancelEditTitle()">{{ 'CANCEL' | translate }}</button>
      </div>

      <div class="header-actions">
        <select class="btn" [ngModel]="theme.theme()" (ngModelChange)="theme.set($event)">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="custom">Custom</option>
        </select>
        <button class="btn" title="Customize colors" (click)="openThemeEditor()">üé®</button>
        <select class="btn" [ngModel]="lang.lang()" (ngModelChange)="lang.set($event)">
          <option value="en">ENG</option>
          <option value="tr">TR</option>
          <option value="az">AZ</option>
        </select>
        <button class="btn primary" (click)="newNote()">{{ 'NEW_NOTE' | translate }}</button>
        <span *ngIf="auth.currentAccountId()" class="meta">
          {{ 'ACCOUNT_NAME' | translate }}: {{ currentAccount()?.name }}
        </span>
        <button class="btn" *ngIf="auth.currentAccountId()" (click)="logout()">{{ 'LOG_OUT' | translate }}</button>

      </div>
    </div>

    <div class="layout">
      <!-- Sidebar: Important Notes -->
      <div class="panel">
        <h2>{{ 'IMPORTANT_NOTES' | translate }}</h2>
        <div class="panel-body">
          <div *ngIf="important().length === 0" class="muted">{{ 'NO_IMPORTANT' | translate }}</div>
          <div *ngFor="let n of important()" class="note-li" (click)="openViewer(n)">
            <div style="flex:1;">
              <h4>{{ n.title || '(No title)' }}</h4>
              <div class="meta">{{ n.dateISO }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main: Calendar + selected day notes -->
      <div class="panel" style="overflow:clip;">
        <div class="cal-head">
          <button class="btn" (click)="prevMonth()">‚Äπ</button>
          <h3>{{ monthLabel() }}</h3>
          <button class="btn" (click)="nextMonth()">‚Ä∫</button>
        </div>

        <div class="cal-grid">
          <div class="dow" *ngFor="let d of dows()">{{ d }}</div>
          <ng-container *ngFor="let d of calendarDays()">
            <div class="day" [class.other]="!d.inMonth" [class.today]="d.isToday"
              [class.selected]="d.iso === selectedDate()" (click)="selectDate(d.iso)">
              <div class="date">{{ d.day }}</div>
              <div *ngIf="hasNotesOn(d.iso)" class="dot"></div>
            </div>
          </ng-container>
        </div>

        <h2 style="padding:0 16px 8px;">{{ 'NOTES_FOR' | translate:{ date: selectedDate() } }}</h2>
        <div class="day-list">
          <div *ngIf="dayNotes().length===0" class="panel-body" style="color:var(--muted)">{{ 'NO_NOTES_DAY' | translate
            }}</div>
          <div *ngFor="let n of dayNotes()" class="note-card">
            <div class="note-top">
              <h4>{{ n.title || '(No title)' }}</h4>
              <div class="meta">{{ (n.isImportant ? 'IMPORTANT' : 'DAILY') | translate }} ¬∑ {{ n.dateISO }}</div>
            </div>
            <div [innerHTML]="n.contentHtml"></div>
            <div *ngIf="n.imageDataUrls?.length"
              style="margin-top:8px; display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:8px;">
              <img *ngFor="let img of n.imageDataUrls" [src]="img" class="thumb" />
            </div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn" (click)="openViewer(n)">{{ 'OPEN' | translate }}</button>
              <button class="btn" title="Edit" (click)="startEdit(n)">‚úèÔ∏è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer: Editor -->
  <div class="drawer" [class.open]="mode() === 'edit'">
    <div class="drawer-head">
      <div>{{ (editId() ? 'EDIT' : 'NEW_NOTE') | translate }}</div>
      <button class="btn" (click)="closeEditor()">‚úï</button>
    </div>
    <div class="drawer-body">
      <div class="row">
        <div>
          <label>{{ 'TITLE' | translate }}</label>
          <input type="text" [(ngModel)]="title" placeholder="Title">
        </div>
        <div>
          <label>{{ 'DATE' | translate }}</label>
          <input type="date" [(ngModel)]="dateISO">
        </div>
      </div>

      <div>
        <label>{{ 'RICH_TEXT' | translate }}</label>
        <rich-text-editor [(value)]="contentHtml"></rich-text-editor>
      </div>

      <div class="row">
        <div>
          <label>{{ 'PICTURES' | translate }}</label>
          <input type="file" accept="image/*" multiple (change)="onImages($event)">

          <div *ngIf="imageDataUrls.length" class="image-grid">
            <div *ngFor="let img of imageDataUrls; let i = index" class="image-cell">
              <img [src]="img" class="thumb" />
              <button type="button" class="img-remove" aria-label="Remove image" (click)="removeImageAt(i)">‚úï</button>
            </div>
          </div>
        </div>


        <div>
          <label><input type="checkbox" [(ngModel)]="isImportant"> {{ 'MARK_IMPORTANT' | translate }}</label>
        </div>
      </div>
    </div>
    <div class="drawer-foot">
      <button class="btn" (click)="closeEditor()">{{ 'CANCEL' | translate }}</button>
      <button class="btn danger" *ngIf="editId()" (click)="remove(editId()!)">{{ 'DELETE' | translate }}</button>
      <button class="btn primary" (click)="save()">{{ (editId() ? 'UPDATE' : 'SAVE') | translate }}</button>
    </div>
  </div>

  <div class="modal" *ngIf="viewerOpen()">
    <div class="backdrop" (click)="closeViewer()"></div>
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div>
          <div class="modal-title">{{ viewNote()?.title || '(No title)' }}</div>
          <div class="meta">{{ viewNote()?.isImportant ? '‚≠ê Important' : 'Daily' }} ¬∑ {{ viewNote()?.dateISO }}</div>
        </div>
        <div class="modal-actions">
          <button class="btn" title="Edit" (click)="editFromViewer()">‚úèÔ∏è</button>
          <button class="btn" (click)="closeViewer()">‚úï</button>
        </div>
      </div>
      <div class="modal-body">
        <div [innerHTML]="viewNote()?.contentHtml"></div>
        <div *ngIf="viewNote()?.imageDataUrls?.length"
          style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:10px;">
          <img *ngFor="let img of viewNote()?.imageDataUrls; let i = index" [src]="img" class="thumb"
            (click)="openImageViewer(viewNote()!.imageDataUrls ?? [], i)" />
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE LIGHTBOX -->
  <div class="lightbox" *ngIf="imageViewerOpen()" tabindex="0" (keydown)="onLightboxKey($event)">
    <div class="lb-backdrop" (click)="closeImageViewer()"></div>

    <div class="lb-content">
      <button class="lb-btn nav left" (click)="prevImage()">‚Äπ</button>

      <div class="lb-stage" (wheel)="onWheel($event)">
        <img [src]="viewerImages[viewerIndex()]" class="lb-img"
          [style.transform]="'translate(' + offset().x + 'px,' + offset().y + 'px) scale(' + zoom() + ')'"
          (mousedown)="startDrag($event)" (mousemove)="drag($event)" (mouseup)="endDrag()" (mouseleave)="endDrag()"
          (dblclick)="toggleZoom()" draggable="false" />
      </div>

      <button class="lb-btn nav right" (click)="nextImage()">‚Ä∫</button>

      <div class="lb-toolbar">
        <span>{{ viewerIndex() + 1 }} / {{ viewerImages.length }}</span>
        <span style="margin-left:12px;">{{ (zoom()*100) | number:'1.0-0' }}%</span>
        <div class="spacer"></div>
        <button class="btn" (click)="zoomOut()">‚àí</button>
        <button class="btn" (click)="resetZoom()">Reset Zoom</button>
        <button class="btn" (click)="zoomIn()">+</button>
        <button class="btn" (click)="closeImageViewer()">‚úï</button>
      </div>
    </div>
  </div>

  <!-- THEME EDITOR -->
  <div class="modal" *ngIf="themeEditorOpen()">
    <div class="backdrop" (click)="closeThemeEditor()"></div>
    <div class="modal-card" style="max-width:720px;">
      <div class="modal-head">
        <div class="modal-title">Theme ‚Äî Custom Colors</div>
        <div class="modal-actions">
          <button class="btn" (click)="resetTheme('light')">Light defaults</button>
          <button class="btn" (click)="resetTheme('dark')">Dark defaults</button>
          <button class="btn" (click)="closeThemeEditor()">‚úï</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row" style="grid-template-columns: repeat(2, 1fr);">
          <div class="color-row">
            <label>Background</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.bg" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.bg" />
            </div>
          </div>

          <div class="color-row">
            <label>Panel</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.panel" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.panel" />
            </div>
          </div>

          <div class="color-row">
            <label>Panel (inner)</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.panel2" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.panel2" />
            </div>
          </div>

          <div class="color-row">
            <label>Border</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.border" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.border" />
            </div>
          </div>

          <div class="color-row">
            <label>Text</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.text" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.text" />
            </div>
          </div>

          <div class="color-row">
            <label>Muted</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.muted" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.muted" />
            </div>
          </div>

          <div class="color-row">
            <label>Primary</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.primary" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.primary" />
            </div>
          </div>

          <div class="color-row">
            <label>Accent</label>
            <div class="pick">
              <input type="color" class="colorbox" [(ngModel)]="paletteDraft.accent" />
              <input type="text" class="hex" [(ngModel)]="paletteDraft.accent" />
            </div>
          </div>

        </div>
      </div>
      <div class="modal-foot"
        style="display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--border);">
        <button class="btn" (click)="closeThemeEditor()">Cancel</button>
        <button class="btn primary" (click)="saveTheme()">Save</button>
      </div>
    </div>
  </div>

</ng-template>

<!-- ADMIN PANEL (hidden by default; open via Ctrl+Shift+A) -->
<div class="admin-panel-backdrop" *ngIf="adminOpen()" (click)="closeAdminPanel()"></div>

<div class="admin-panel" *ngIf="adminOpen()">
  <div class="admin-head">
    <h3>Admin ‚Äî Reset Account Password</h3>
    <button class="btn" (click)="closeAdminPanel()">‚úï</button>
  </div>

  <div class="admin-body" style="padding:12px; display:grid; gap:8px;">
    <label>Account</label>
    <select [(ngModel)]="adminSelectedAccountId" class="btn" style="width:100%;">
      <option *ngFor="let a of auth.accounts()" [ngValue]="a.id">{{ a.name }}</option>
    </select>

    <label>New password</label>
    <input type="password" [(ngModel)]="adminNewPassword" class="btn" style="width:100%;" />

    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" (click)="closeAdminPanel()">Cancel</button>
      <button class="btn primary" (click)="adminResetPassword()">Reset Password</button>
    </div>
  </div>
</div>